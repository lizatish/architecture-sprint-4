# Метрики

## Мотивация

Мониторинг метрик поможет находить узкие места системы заранее, до того, как проблема станет известна от конечных
пользователей. Это важно для бизнеса, так как предотвращение проблем на корню сохраняет положительный пользовательский
опыт.

## Выбор подхода к мониторингу

Для микросервиса по расчету сложных CPU-задач MES Order Service предлагается использовать подход USE, так как это
ресурс, производительность которого снижается при интенсивном использовании.
Для всех остальных микросервисов стоит ввести подход “Четыре золотых правила”, так как с ними происходит взаимодействие
по API.
Для CRM API и MES Clients API необходимо измерять USE-метрики по наполненности очередей RabbitMQ, так как это важный
параметр.

## Перечень метрик для отслеживания

- Число dead-letter-exchange очереди на просчет в MES Order Service - нужна, чтобы отследить ошибки в сервисе просчета.
  Метки: источник - от клиентов интернет-магазина, от пользователей API
- Число сообщений в очереди на просчет в MES Order Service - нужна, чтобы отследить производительность сервиса и
  определить, в какой момент нужно масштабировать воркеров или, наоборот, можно сократить их количество. Метки:
  источник -
  от клиентов интернет-магазина, от пользователей API
- Время расчета задачи каждым воркером в MES Order Service - нужна, чтобы отслеживать динамику выполнения заказов,
  отслеживать возникновение узких мест в MES, например, когда задача надолго зависает. Метки: уникальный идентификатор
  воркера
- CPU для Internet Shop - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться и как система
  выдерживает нагрузку
- CPU для CRM - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться и как система выдерживает
  нагрузку
- CPU для MES clients API - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться и как система
  выдерживает нагрузку
- CPU для MES Operators API - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться и как
  система
  выдерживает нагрузку
- CPU для сервиса 3D-моделирования - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться и как
  система выдерживает нагрузку
- Memory Utilization для InternetShop - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться
  и как система выдерживает нагрузку
- Memory Utilization для CRM - поможет отслеживать насыщенность, вовремя понять, когда нужно масштабироваться и как
  система выдерживает нагрузку
- Memory Utilization для MES clients API - поможет отслеживать насыщенность, вовремя понять, когда нужно
  масштабироваться
  и как система выдерживает нагрузку
- Memory Utilization для MES Operators API - поможет отслеживать насыщенность, вовремя понять, когда нужно
  масштабироваться и как система выдерживает нагрузку
- Memory Utilization для сервиса 3D-моделирования - поможет отслеживать насыщенность, вовремя понять, когда нужно
  масштабироваться и как система выдерживает нагрузку
- RPS для InternetShop - поможет оценить трафик системы, провести корреляцию влияния трафика на насыщенность системы
- RPS для сервиса 3D-моделирования - поможет оценить трафик системы, провести корреляцию влияния трафика на насыщенность
  системы
- RPS для CRM - поможет оценить трафик системы, провести корреляцию влияния трафика на насыщенность системы
- RPS для MES clients API - поможет оценить трафик системы, провести корреляцию влияния трафика на насыщенность системы
- RPS для MES Operators API - поможет оценить трафик системы, провести корреляцию влияния трафика на насыщенность
  системы
- RPS per user для InternetShop - поможет отследить длительность нахождения конечного пользователя в сервисе, что важно
  для отслеживания повышения качества системы на длительность нахождения пользователя
- RPS per user per user для CRM - поможет отследить длительность нахождения конечного пользователя в сервисе, что важно
  для отслеживания повышения качества системы на длительность нахождения пользователя
- Число соединение для shop db - поможет отследить нагрузку на БД
- Число соединений для MES db - поможет отследить нагрузку на БД
- Занимаемая память для shop db - поможет отследить размер БД, когда он станет слишком большим, необходимо будет
  шардировать БД
- Занимаемая память для MES db - поможет отследить размер БД, когда он станет слишком большим, необходимо будет
  шардировать БД
- Занимаемая память для S3 storage - поможет отследить размер БД, когда он станет слишком большим, необходимо будет
  шардировать БД
- Число HTTP 200 for shop API - поможет отследить количество корректных ответов и общее состояние системы
- Число HTTP 200 for CRM API - поможет отследить количество корректных ответов и общее состояние системы
- Число HTTP 200 for MES Operators API - поможет отследить количество корректных ответов и общее состояние системы
- Число HTTP 200 for MES Clients API - поможет отследить количество корректных ответов и общее состояние системы
- Число HTTP 200 для сервиса 3D-моделирования - поможет отследить количество корректных ответов и общее состояние
  системы
- Время отклика (латентность) для shop API - поможет отслеживать важный параметр, влияющий напрямую на опыт
  пользователя, его увеличение покажет то, что в системе все глобально не все гладко
- Время отклика (латентность) для CRM API - поможет отслеживать важный параметр, влияющий напрямую на опыт пользователя,
  его увеличение покажет то, что в системе все глобально не все гладко
- Время отклика (латентность) MES Operators API - поможет отслеживать важный параметр, влияющий напрямую на опыт
  пользователя, его увеличение покажет то, что в системе все глобально не все гладко
- Время отклика (латентность) MES Clients API - поможет отслеживать важный параметр, влияющий напрямую на опыт
  пользователя, его увеличение покажет то, что в системе все глобально не все гладко
- Время отклика (латентность) для сервиса 3D-моделирования - поможет отслеживать важный параметр, влияющий напрямую на
  опыт пользователя, его увеличение покажет то, что в системе все глобально не все гладко
- Число HTTP 500 for shop API - поможет отследить количество некорректных ответов и общее состояние системы
- Число HTTP 500 for CRM API - поможет отследить количество некорректных ответов и общее состояние системы
- Число HTTP 500 for MES Operators API - поможет отследить количество некорректных ответов и общее состояние системы
- Число HTTP 500 for MES Clients API - поможет отследить количество некорректных ответов и общее состояние системы
- Число HTTP 500 for shop API - поможет отследить количество некорректных ответов и общее состояние системы
- Число HTTP 500 для сервиса 3D-моделирования - поможет отследить количество некорректных ответов и общее состояние
  системы
- Количество одновременных соединений к системе 3D-моделирования

## План действий

1) Развернуть Prometheus Server
2) Развернуть Grafana
3) Написать pull-механизмы в Prometheus: по отслеживанию состояния очередей, состояния баз
4) Проверить наличие новых метрик в Prometheus, создать новые дашборды Grafana
5) Настроить nginx для передачи метрик API
6) Проверить наличие новых метрик в Prometheus, создать новые дашборды Grafana
7) Настроить микросервисы и БД для передачи метрик СPU, Memory
8) Проверить наличие новых метрик в Prometheus, создать новые дашборды Grafana

## Показатели насыщенности

- Для очередей:  отсутствие роста очереди за 60 минут
- CPU - не более 80% средней загрузки за 60 минут
- Memory - не более 80% средней загрузки за 60 минут
- RPS - зависит от поставленного ТЗ, порог - на 20% меньше от поставленного в ТЗ в среднем за 60 минут

Подобные показатели насыщенности созданы для того, чтобы определить, что система находится на почти предельных
  показателях и за ней нужно наблюдать или уже искать причину возникновения проблемы. Так как если ставить насыщенность
  на
  максимальные показатели - в моменте возникновения проблемы может стать уже поздно ее решать заблаговременно.
